

/* web/extensions/FSK/Selcall.min.js (web/extensions/FSK/Selcall.js = Wed Jun  1 10:38:30 2022) */
function Selcall(s,e){var r=this;console.log("FSK encoder: Selcall"),r.dbg=0,r.dump_always=1,r.dump_non_std_len=1,r.dump_no_eos=0,r.zoom=10,r.start_bit=0,r.seq=0,r.pkt=0,r.MSG_LEN_MIN=30,r.MSG_LEN_MAX=80,r.synced=0,r.sym_s=["   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","RTN","   ","   ","   ","Pr0","Pr1","Pr2","Pr3","Pr4","Pr5","   ","   ","   ","   ","   ","   ","   ","ARQ","   ","   ","SEL","   ","ABQ","SMA","   ","Pdx","  *","EOS"],r.DX=125,r.RX5=109,r.FMT_GEO_AREA=102,r.FMT_DISTRESS=112,r.FMT_COMMON_INTEREST=114,r.FMT_ALL_SHIPS=116,r.FMT_INDIV_STA=120,r.FMT_RESV=121,r.FMT_IS_SEMI_AUTO=123,r.CAT_ROUTINE=100,r.CAT_SAFETY=108,r.CAT_URGENCY=110,r.CAT_DISTRESS=112,r.CMD1_FM_CALL=100,r.CMD1_FM_DUPLEX_CALL=101,r.CMD1_POLLING=103,r.CMD1_UNABLE_COMPLY=104,r.CMD1_END_OF_CALL=105,r.CMD1_F1B_DATA=106,r.CMD1_J3E_RT=109,r.CMD1_DISTRESS_ACK=110,r.CMD1_DISTRESS_ALERT_RELAY=112,r.CMD1_F1B_FEC=113,r.CMD1_F1B_ARQ=115,r.CMD1_TEST=118,r.CMD1_POSITION=121,r.CMD1_NOP=126,r.CMD2_UNABLE_FIRST=100,r.CMD2_BUSY=102,r.CMD2_UNABLE_LAST=109,r.CMD2_NON_CONFLICT=110,r.CMD2_MED_TRANSPORTS=111,r.CMD2_NOP=126,r.ARQ=117,r.ABQ=122,r.EOS=127,r.NOP=126,r.pos_s=["dx","rx5","dx","rx4","dx","rx3","dx","rx2","dx","rx1","dx","rx0","fmt","fmt","B1","fmt","B2","fmt","cat","B1","A1","B2","A2","cat","eos","A1","eos","A2","eos","eos"],r.pos={},r.pos_n={},r.pos_s.forEach(function(s,e){s=s.trim(),isDefined(r.pos_n[s])||(r.pos_n[s]=0),r.pos[s+"-"+r.pos_n[s].toString()]=e,r.pos_n[s]++}),r.dbg&&console.log(r.pos);function n(s){return s=kiwi_bitCount(127^s),kiwi_bitReverse(s,3)}r.DX_w=n(r.DX)<<7|r.DX,r.svec=[];for(var o=r.RX5,_=0;_<12;_++)r.svec[_]=1&_?n(o)<<7|o:r.DX_w,1&_&&o--;r.dbg&&console.log(r.svec)}Selcall.prototype.sym_by_sym_name=function(s){s=this.pos[s];return{pos:s,sym:this.syms[s]}},Selcall.prototype.output_msg=function(s){return(new Date).toUTCString().substr(17,8)+" "+(ext_get_freq()/1e3).toFixed(2)+" "+s+"\n"},Selcall.prototype.code_to_char=function(s){return s<0||127<s?"???":this.sym_s[s]},Selcall.prototype.reset=function(){var s=this;s.syncA=s.syncB=s.syncC=s.syncD=s.syncE=0},Selcall.prototype.get_nbits=function(){return 10},Selcall.prototype.get_msb=function(){return 512},Selcall.prototype.check_bits=function(){return!1},Selcall.prototype.search_sync=function(s){var e=this,r=s,s=1&e.syncA;e.syncA=e.syncA>>1&1023,e.syncA|=r?512:0,r=s,s=1&e.syncB,e.syncB=e.syncB>>1&1023,e.syncB|=r?512:0,r=s,s=1&e.syncC,e.syncC=e.syncC>>1&1023,e.syncC|=r?512:0,r=s,s=1&e.syncD,e.syncD=e.syncD>>1&1023,e.syncD|=r?512:0,r=s,s=1&e.syncE,e.syncE=e.syncE>>1&1023,e.syncE|=r?512:0;for(var n=0;n<=9;n++)if(e.syncC==e.svec[n]&&e.syncB==e.svec[n+1]&&e.syncA==e.svec[n+2])return console.log("SYNC-DRD-"+n),e.seq=n+3,e.full_syms=[],e.syms=[],e.bc_err=[],e.parity_errors=0,e.FEC_errors=0,e.synced=1,!0;for(n=1;n<=7;n+=2)if(e.syncE==e.svec[n]&&e.syncC==e.svec[n+2]&&e.syncA==e.svec[n+4])return console.log("SYNC-RRR-"+n),e.seq=n+5,e.full_syms=[],e.syms=[],e.bc_err=[],e.parity_errors=0,e.FEC_errors=0,e.synced=1,!0;return e.synced=0,!1},Selcall.prototype.process_char=function(s,e,r,n){var o=this;if(!o.synced)return{resync:0};12==o.seq&&o.pkt++;var _=(o.full_syms[o.seq]=s)>>7&7,c=127&s;o.syms[o.seq]=c,C=(C=o.pos_s[o.seq])||"unk";var t=o.code_to_char(c),i=(A=(i=kiwi_bitReverse(_,3))!=(D=kiwi_bitCount(127^c)))?" Zck="+i+" Zdata="+D:"";(o.bc_err[o.seq]=A)&&o.parity_errors++,o.dbg&&console.log(o.seq.leadingZeros(2)+" "+C.fieldWidth(6)+": "+t+" "+c.fieldWidth(3)+". "+_.toString(2).leadingZeros(3)+" "+c.toString(2).leadingZeros(7)+i),o.seq++;D=!1;if(o.seq>=o.MSG_LEN_MIN){function l(s){var e={code:127&o.full_syms[s],fec_err:!1};if(o.bc_err[s]){if(s+5<o.seq&&!o.bc_err[s+5])return e.code=127&o.full_syms[s+5],e;e.code=-1,e.fec_err=!0}return e}t=function(s){var e=0;return o.bc_err[o.seq-1]||o.syms[o.seq-1]!=s||e++,o.bc_err[o.seq-2]||o.syms[o.seq-2]!=s||e++,o.bc_err[o.seq-4]||o.syms[o.seq-4]!=s||e++,o.bc_err[o.seq-6]||o.syms[o.seq-6]!=s||e++,3<=e&&console.log("eos_n("+s+")="+e),3<=e},_=function(s,e){return s+e+ansi.NORM},i=function(s,e,r){return w3_link("w3-esc-html w3-link-darker-color","www.marinetraffic.com/en/ais/home/centerx:"+r+"/centery:"+e+"/zoom:"+o.zoom,s)};if((D=t(o.EOS)||t(o.ARQ)||t(o.ABQ)?!0:D)||o.seq>o.MSG_LEN_MAX){t=o.dump_always;if(D?o.seq!=o.MSG_LEN_MIN&&(console.log("$$ non-std len="+o.seq),t|=o.dump_non_std_len):(A=o.parity_errors?" "+_(ansi.BLUE,o.parity_errors+" PE"):"",console.log("$$ no EOS pe="+o.parity_errors),t|=o.dump_no_eos),t){for(var y,a=!1,S=-1,u=0,f=[],d=(new Date).toUTCString().substr(17,8)+" "+(ext_get_freq()/1e3).toFixed(2)+" ",p=0;p<o.seq;p++){var C,E,M,i,D,A,s=o.full_syms[p],c=127&(s=isUndefined(s)?119:s);C=(C=o.pos_s[p])||"unk",1&p||p<12||(c=(E=l(p)).code,E.fec_err&&(a=!0),14==p&&99<l(18).code&&(f.push("  "),d+="__ "),20==p&&99<l(24).code&&(f.push("  "),d+="__ "),E.fec_err?(d+="X ",M="0"):(u!=(M=c<=99?c.leadingZeros(2):c.toString()).length&&(S=(S+1)%ansi.rolling_n,y=ansi[ansi.rolling[S]],u=M.length),d+=y+M+ansi.NORM+" "),f.push(M))}if(a)d+=_(ansi.RED,"FEC");else{var m=0;if(m=121==+f[8]?10:m){for(var T="",p=0;p<=6;p++)T+=f[m+p];t=T.slice(1,3)+"."+T.slice(3,5),_=T.slice(5,8)+"."+T.slice(8,10);d+=i("["+t+","+_+"]",+t,+_),d+=i("*",-t,+_)+" ",d+=i("["+(T.slice(1,3)+"°"+T.slice(3,5)+"'")+","+(T.slice(5,8)+"°"+T.slice(8,10)+"'")+"]",+(T.slice(1,3)+(+T.slice(3,5)/60).toFixed(2).slice(1)),+(T.slice(5,8)+(+T.slice(8,10)/60).toFixed(2).slice(1)))+" ",d+=T.slice(10,12)+":"+T.slice(12,14)}}console.log("fec_errors="+a+" show_errs="+n),a&&!n||r(d+"\n")}return o.synced=0,{resync:1}}}return{resync:0}};



