

/* web/extensions/FSK/Selcall.min.js (web/extensions/FSK/Selcall.js = Wed Jun 15 09:44:40 2022) */
function Selcall(e,s){var r=this;console.log("FSK encoder: Selcall"),r.dbg=0,r.dump_always=1,r.dump_non_std_len=1,r.dump_no_eos=0,r.zoom=10,r.start_bit=0,r.seq=0,r.pkt=0,r.MSG_LEN_MIN=30,r.MSG_LEN_MAX=80,r.synced=0,r.sym_s=["   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","   ","RTN","   ","   ","   ","Pr0","Pr1","Pr2","Pr3","Pr4","Pr5","   ","   ","   ","   ","   ","   ","   ","ARQ","   ","   ","SEL","   ","ABQ","SMA","   ","Pdx","  *","EOS"],r.DX=125,r.RX5=109,r.FMT_GEO_CALL=102,r.FMT_DISTRESS=112,r.FMT_GROUP_CALL=114,r.FMT_ALL_STATIONS=116,r.FMT_INDIV_CALL=120,r.FMT_RESV=121,r.FMT_INDIV_SEMI_AUTO=123,r.CAT_ROUTINE=100,r.CAT_SHIPS_BUSINESS=106,r.CAT_SAFETY=108,r.CAT_URGENCY=110,r.CAT_DISTRESS=112,r.CMD1_FM_CALL=100,r.CMD1_FM_DUPLEX_CALL=101,r.CMD1_POLLING=103,r.CMD1_UNABLE_COMPLY=104,r.CMD1_END_OF_CALL=105,r.CMD1_F1B_DATA=106,r.CMD1_J3E_RT=109,r.CMD1_DISTRESS_ACK=110,r.CMD1_DISTRESS_ALERT_RELAY=112,r.CMD1_F1B_FEC=113,r.CMD1_F1B_ARQ=115,r.CMD1_TEST=118,r.CMD1_POSITION=121,r.CMD1_NOP=126,r.CMD2_UNABLE_FIRST=100,r.CMD2_BUSY=102,r.CMD2_UNABLE_LAST=109,r.CMD2_NON_CONFLICT=110,r.CMD2_MED_TRANSPORTS=111,r.CMD2_NOP=126,r.ARQ=117,r.ABQ=122,r.EOS=127,r.NOP=126,r.pos_s=["dx","rx5","dx","rx4","dx","rx3","dx","rx2","dx","rx1","dx","rx0","fmt","fmt","B1","fmt","B2","fmt","cat","B1","A1","B2","A2","cat","eos","A1","eos","A2","eos","eos"],r.pos={},r.pos_n={},r.pos_s.forEach(function(e,s){e=e.trim(),isDefined(r.pos_n[e])||(r.pos_n[e]=0),r.pos[e+"-"+r.pos_n[e].toString()]=s,r.pos_n[e]++}),r.dbg&&console.log(r.pos);function n(e){return e=kiwi_bitCount(127^e),kiwi_bitReverse(e,3)}r.DX_w=n(r.DX)<<7|r.DX,r.svec=[];for(var _=r.RX5,o=0;o<12;o++)r.svec[o]=1&o?n(_)<<7|_:r.DX_w,1&o&&_--;r.dbg&&console.log(r.svec)}Selcall.prototype.sym_by_sym_name=function(e){e=this.pos[e];return{pos:e,sym:this.syms[e]}},Selcall.prototype.output_msg=function(e){return(new Date).toUTCString().substr(17,8)+" "+(ext_get_freq()/1e3).toFixed(2)+" "+e+"\n"},Selcall.prototype.code_to_char=function(e){return e<0||127<e?"???":this.sym_s[e]},Selcall.prototype.reset=function(){var e=this;e.syncA=e.syncB=e.syncC=e.syncD=e.syncE=0},Selcall.prototype.get_nbits=function(){return 10},Selcall.prototype.get_msb=function(){return 512},Selcall.prototype.check_bits=function(){return!1},Selcall.prototype.search_sync=function(e){var s=this,r=e,e=1&s.syncA;s.syncA=s.syncA>>1&1023,s.syncA|=r?512:0,r=e,e=1&s.syncB,s.syncB=s.syncB>>1&1023,s.syncB|=r?512:0,r=e,e=1&s.syncC,s.syncC=s.syncC>>1&1023,s.syncC|=r?512:0,r=e,e=1&s.syncD,s.syncD=s.syncD>>1&1023,s.syncD|=r?512:0,r=e,e=1&s.syncE,s.syncE=s.syncE>>1&1023,s.syncE|=r?512:0;for(var n=0;n<=9;n++)if(s.syncC==s.svec[n]&&s.syncB==s.svec[n+1]&&s.syncA==s.svec[n+2])return console.log("SYNC-DRD-"+n),s.seq=n+3,s.full_syms=[],s.syms=[],s.bc_err=[],s.parity_errors=0,s.FEC_errors=0,s.synced=1,!0;for(n=1;n<=7;n+=2)if(s.syncE==s.svec[n]&&s.syncC==s.svec[n+2]&&s.syncA==s.svec[n+4])return console.log("SYNC-RRR-"+n),s.seq=n+5,s.full_syms=[],s.syms=[],s.bc_err=[],s.parity_errors=0,s.FEC_errors=0,s.synced=1,!0;return s.synced=0,!1},Selcall.prototype.process_char=function(e,s,r,n,_){var o=this;if(!o.synced)return{resync:0};12==o.seq&&o.pkt++;var t=(o.full_syms[o.seq]=e)>>7&7,c=127&e;o.syms[o.seq]=c,N=(N=o.pos_s[o.seq])||"unk";var i=o.code_to_char(c),l=(I=(O=kiwi_bitReverse(t,3))!=(m=kiwi_bitCount(127^c)))?" Zck="+O+" Zdata="+m:"";(o.bc_err[o.seq]=I)&&o.parity_errors++,o.dbg&&console.log(o.seq.leadingZeros(2)+" "+N.fieldWidth(6)+": "+i+" "+c.fieldWidth(3)+". "+t.toString(2).leadingZeros(3)+" "+c.toString(2).leadingZeros(7)+l),o.seq++;var y=!1;if(o.seq>=o.MSG_LEN_MIN){function a(e,s){return e+s+ansi.NORM}function u(e,s){return"https://www.marinetraffic.com/en/ais/home/centerx:"+s+"/centery:"+e+"/zoom:"+o.zoom}function S(e,s,r){return w3_link("w3-esc-html w3-link-darker-color",u(s,r),e)}function d(e){var s={code:127&o.full_syms[e],fec_err:!1};if(o.bc_err[e]){if(e+5<o.seq&&!o.bc_err[e+5])return s.code=127&o.full_syms[e+5],s;s.code=-1,s.fec_err=!0}return s}var C=function(e){var s=0;return o.bc_err[o.seq-1]||o.syms[o.seq-1]!=e||s++,o.bc_err[o.seq-2]||o.syms[o.seq-2]!=e||s++,o.bc_err[o.seq-4]||o.syms[o.seq-4]!=e||s++,o.bc_err[o.seq-6]||o.syms[o.seq-6]!=e||s++,3<=s&&console.log("eos_n("+e+")="+s),3<=s};if((y=C(o.EOS)||C(o.ARQ)||C(o.ABQ)?!0:y)||o.seq>o.MSG_LEN_MAX){O=o.dump_always;if(y?o.seq!=o.MSG_LEN_MIN&&(console.log("$$ non-std len="+o.seq),O|=o.dump_non_std_len):(I=o.parity_errors?" "+a(ansi.BLUE,o.parity_errors+" PE"):"",console.log("$$ no EOS pe="+o.parity_errors),O|=o.dump_no_eos),O){for(var f,p,A=!1,D=-1,E=0,M=[],m=ext_get_freq()/1e3,L=(new Date).toUTCString().substr(17,8)+" "+m.toFixed(2)+" ",i=d(12).code,T=0;T<o.seq;T++){var N,g,R,m,e=o.full_syms[T],c=127&(e=isUndefined(e)?119:e);N=(N=o.pos_s[T])||"unk",1&T||T<12||(c=(g=d(T)).code,g.fec_err&&(A=!0),14==T&&(99<d(18).code?(M.push("  "),L+="__ "):d(20).code),20==T&&(99<(p=d(24).code)?(M.push("  "),L+="__ "):p=d(28).code),g.fec_err?(L+="X ",R="0"):(E!=(R=c<=99?c.leadingZeros(2):c.toString()).length&&(D=(D+1)%ansi.rolling_n,f=ansi[ansi.rolling[D]],E=R.length),L+=f+R+ansi.NORM+" "),M.push(R))}t=null;if(A)L+=a(ansi.RED,"FEC");else{var v,l=i==o.FMT_INDIV_CALL||i==o.FMT_INDIV_SEMI_AUTO;if(l&&(b=+M[1]?a(ansi.CYAN,M[1]+M[2]+M[3]):a(ansi.CYAN,"__"+M[2]+M[3]),t=(+M[5]?(v=M[5]+M[6]+M[7],a(ansi.YELLOW,v)):(v=M[6]+M[7],a(ansi.YELLOW,"__"+v)))+" calling "+b),l&&p==o.CMD1_POSITION){for(var F="",T=0;T<=6;T++)F+=M[T+10];var C=F.slice(1,3),y=F.slice(5,8),I=F.slice(3,5),O=F.slice(8,10),i=C+"."+I,b=y+"."+O;t+=", position "+S("["+i+","+b+"]",+i,+b);l=!1,i=+I,b=+O;60<=i&&(i=59,l=!0),60<=b&&(b=59,l=!0);I=C+"°"+I+"'",O=y+"°"+O+"'",i=C+(i/60).toFixed(2).slice(1),b=y+(b/60).toFixed(2).slice(1);t+=" "+S("["+I+","+O+"]",+i,+b),t+=" "+F.slice(10,12)+":"+F.slice(12,14),navtex_location_update(v,+i,+b,u(+i,+b),l?["white","red"]:["white",m<7500?"magenta":"blue"])&&(t+=" "+a(ansi.YELLOW,"(dupe)"))}t=t&&(new Date).toUTCString().substr(17,8)+" "+m.toFixed(2)+" "+t}console.log("fec_errors="+A+" show_errs="+_),!A&&t&&r(t+"\n"),(!A&&(!t||n)||A&&_)&&r(L+"\n")}return o.synced=0,{resync:1}}}return{resync:0}};



