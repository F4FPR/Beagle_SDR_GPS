

/* web/extensions/HFDL/HFDL.min.js */
var hfdl={ext_name:"HFDL",first_time:!0,dataH:300,ctrlW:600,ctrlH:185,freq:0,sfmt:"w3-text-red w3-ext-retain-input-focus",pb:{lo:300,hi:2600},stations:null,url:"http://kiwisdr.com/hfdl/systable.cjson",using_default:!1,double_fault:!1,bf:[4,5,6,8,10,11,13,15,17,21,23],bf_s:["3","4.6","5.5","6.5","8.9","10","11.3","13.3","15","18","22"],bf_z:[4,9,6,7,7,8,7,8,8,8,8],bf_c:[3500,4670,5600,6625,8900,10065,11290,13310,15020,17945,21965],ALL:0,DX:1,SQUITTER:2,dsp:0,dsp_s:["all","DX","squitter"],uplink:!0,downlink:!0,testing:!1,log_mins:0,log_interval:null,log_txt:"",menu_n:0,menu_s:[],menus:[],menu_sel:"",console_status_msg_p:{scroll_only_at_bottom:!0,process_return_alone:!1,remove_returns:!0,ncol:135}};function HFDL_main(){ext_switch_to_client(hfdl.ext_name,hfdl.first_time,hfdl_recv),hfdl.first_time||hfdl_controls_setup(),hfdl.first_time=!1}function hfdl_recv(e){if("DAT"!=arrayBufferToStringLen(e,3))for(var l=arrayBufferToString(e).substring(4).split(" "),t=0;t<l.length;t++){var n=l[t].split("=");switch(n[0]){case"ready":hfdl_controls_setup();break;case"bar_pct":if(hfdl.testing){var d=w3_clamp(parseInt(n[1]),0,100),o=w3_el("id-hfdl-bar");o&&(o.style.width=d+"%")}break;case"test_start":hfdl_test_cb("",1);break;case"test_done":hfdl.testing&&(w3_hide("id-hfdl-bar-container"),w3_show("id-hfdl-record"));break;case"chars":var s=n[1],_=kiwi_decodeURIComponent("",n[1]).split("\n");if(!hfdl.uplink&&_[1].startsWith("Uplink"))break;if(!hfdl.downlink&&_[1].startsWith("Downlink"))break;if(hfdl.dsp!=hfdl.ALL)switch(_.forEach(function(e,l){_[l]=e.trim()}),hfdl.dsp){case hfdl.DX:if(s=_[0]+"\n"+_[1].slice(0,-1)+" | "+_[2],_[3].startsWith("Squitter")){s+=" | Squitter: ";var i=!0;_.forEach(function(e,l){if(!(l<=3)&&e.startsWith("ID:")){var t=e.split(", ");t.length<2||""==t[1]||(s+=(i?"":", ")+t[1],i=!1)}}),s+="\n";break}s+=" | "+_[3];var a=!1;["Logon request","Logon resume","Logon confirm","Unnumbered data","Unnumbered ack'ed"].forEach(function(e,l){!a&&_[4].includes(e)&&(a=!0,s+=" | "+e,_.forEach(function(e,l){if(!(l<=4)){var t=e.split(":"),n=t[0],d=t[1]&&""!=t[1]?t[1].slice(1):null;"ICAO"==n&&d?s+=" | ICAO "+d:"Flight ID"==n&&d?s+=" | Flight "+d:"Lat"==n&&d?s+=" | Lat "+(+d).toFixed(4):"Lon"==n&&d?s+=" | Lon "+(+d).toFixed(4):"ACARS"==n&&(s+=" | ACARS...")}}))}),a||(s+=" | "+_[4]),s+="\n";break;case hfdl.SQUITTER:if(!_[3].startsWith("Squitter")){s="";break}s=_[0]+"\nSquitter | "+_[2]+"\n";var r="";_.forEach(function(e,l){e.startsWith("ID:")?r=e.split(": ")[1]:e.startsWith("Frequencies in use:")&&(s+=r+": "+e.split(": ")[1]+"\n")})}""!=s&&hfdl_decoder_output_chars(s);break;default:console.log("hfdl_recv: UNKNOWN CMD "+n[0])}}else{var f=new Uint8Array(e,4),h=f[0];console.log("hfdl_recv: DATA UNKNOWN cmd="+h+" len="+(f.length-1))}}function hfdl_decoder_output_chars(e){hfdl.console_status_msg_p.s=e,hfdl.log_txt+=kiwi_remove_ANSI_escape_sequences(kiwi_decodeURIComponent("HFDL",e)),kiwi_output_msg("id-hfdl-console-msgs","id-hfdl-console-msg",hfdl.console_status_msg_p)}function hfdl_controls_setup(){var e=time_display_html("hfdl")+w3_div("id-hfdl-data|left:150px; width:1044px; height:"+px(hfdl.dataH)+"; overflow:hidden; position:relative; background-color:mediumBlue;",w3_div("id-hfdl-console-msg w3-text-output w3-scroll-down w3-small w3-text-black|left: 10px; width:1024px; position:absolute; overflow-x:hidden;",'<pre><code id="id-hfdl-console-msgs"></code></pre>')),l=w3_div("id-hfdl-controls w3-text-white",w3_col_percent("w3-tspace-8 w3-valign/",w3_div("w3-medium w3-text-aqua","<b>HFDL decoder</b>"),25,w3_div("",'From <b><a href="https://github.com/szpajder/dumphfdl" target="_blank">dumphfdl</a></b> by Tomasz Lemiech &copy;2021 GPL-3.0</b>')),w3_inline("w3-tspace-4 w3-halign-space-between/",w3_div("id-hfdl-msg")),w3_inline("w3-margin-T-16/w3-margin-between-16",w3_inline("w3-valign-end w3-round-large w3-padding-small w3-text-white w3-grey/",w3_select(hfdl.sfmt,"Display","","hfdl.dsp",hfdl.dsp,hfdl.dsp_s,"hfdl_display_cb"),w3_div("w3-margin-L-16",w3_checkbox("/w3-label-inline w3-label-not-bold","Uplink","hfdl.uplink",hfdl.uplink,"w3_bool_cb"),w3_checkbox("/w3-label-inline w3-label-not-bold","Downlink","hfdl.downlink",hfdl.downlink,"w3_bool_cb"))),w3_inline("id-hfdl-menus w3-tspace-6 w3-gap-16/")),w3_inline("w3-tspace-8 w3-valign/w3-margin-between-12",w3_button("w3-padding-smaller","Next","w3_select_next_prev_cb",{dir:w3_MENU_NEXT,id:"hfdl.menu",isNumeric:!0,func:"hfdl_np_pre_select_cb"}),w3_button("w3-padding-smaller","Prev","w3_select_next_prev_cb",{dir:w3_MENU_PREV,id:"hfdl.menu",isNumeric:!0,func:"hfdl_np_pre_select_cb"}),w3_button("id-hfdl-clear-button w3-padding-smaller w3-css-yellow","Clear","hfdl_clear_button_cb"),w3_button("id-button-test w3-padding-smaller w3-aqua","Test","hfdl_test_cb",1),w3_div("id-hfdl-bar-container w3-progress-container w3-round-large w3-white w3-hide|width:70px; height:16px",w3_div("id-hfdl-bar w3-progressbar w3-round-large w3-light-green|width:0%","&nbsp;")),w3_input("id-hfdl-log-mins/w3-label-not-bold/w3-ext-retain-input-focus|padding:0;width:auto|size=4","log min","hfdl.log_mins",hfdl.log_mins,"hfdl_log_mins_cb")));ext_panel_show(l,e,null),ext_set_data_height(hfdl.dataH),ext_set_controls_width_height(hfdl.ctrlW,hfdl.ctrlH),time_display_setup("hfdl"),hfdl_msg("w3-text-css-yellow","&nbsp;"),HFDL_environment_changed({resize:1,freq:1}),hfdl.save_agc_delay=ext_agc_delay(100),ext_send("SET start"),hfdl.saved_mode=ext_get_mode(),ext_set_mode("iq"),ext_set_passband(hfdl.pb.lo,hfdl.pb.hi),12e3!=ext_nom_sample_rate()&&w3_add("id-button-test","w3-disabled"),w3_do_when_rendered("id-hfdl-menus",function(){ext_send("SET reset"),hfdl.double_fault=!1,dbgUs?kiwi_ajax(hfdl.url+".xxx","hfdl_get_systable_done_cb",0,-500):kiwi_ajax(hfdl.url,"hfdl_get_systable_done_cb",0,1e4)})}function hfdl_watchdog(){}function hfdl_menu_match(e,l){var t={found_menu_match:!1,match_menu:0,match_val:0},n="hfdl.menu1",d=!1,o=!1;return dbgUs&&console.log("CONSIDER "+n+" -----------------------------------------"),w3_select_enum(n,function(s,_){var i=+s.value;if(!t.found_menu_match&&-1!=i){var a=parseFloat(s.innerHTML),r=s.innerHTML.toLowerCase();if(dbgUs&&console.log("CONSIDER "+i+" "+s.innerHTML),d){if(s.disabled)return;o=!0}else if(isNumber(a))a==e&&(dbgUs&&console.log("MATCH num: "+r+"["+_+"]"),o=!0);else if(r.includes(l))return d=!0,void(dbgUs&&console.log("MATCH str: "+r+"["+_+"] BEGIN look_for_first_entry"));o&&(dbgUs&&console.log("MATCH "+i+" "+s.innerHTML),t.match_menu=n,t.match_val=i,t.found_menu_match=!0)}}),t}function hfdl_get_systable_done_cb(e){var l=hfdl.url,t=!1;if(e?e.AJAX_error&&"timeout"==e.AJAX_error?(console.log("hfdl_get_systable_done_cb: TIMEOUT"),hfdl.using_default=!0,t=!0):isObject(e)||(console.log("hfdl_get_systable_done_cb: not array"),t=!0):(console.log("hfdl_get_systable_done_cb: stations="+e),t=!0),t){if(hfdl.double_fault)return console.log("hfdl_get_systable_done_cb: default station list fetch FAILED"),void console.log(e);console.log(e);l=kiwi_url_origin()+"/extensions/HFDL/systable.cjson";return console.log("hfdl_get_systable_done_cb: using default station list "+l),hfdl.using_default=!0,hfdl.double_fault=!0,void kiwi_ajax(l,"hfdl_get_systable_done_cb",0,1e4)}if(console.log("hfdl_get_systable_done_cb: from "+l),isDefined(e.AJAX_error))console.log(e);else{if(hfdl.stations=e,hfdl_render_menus(),hfdl.url_params=ext_param(),dbgUs&&console.log("url_params="+hfdl.url_params),hfdl.url_params){var n=hfdl.url_params.split(","),d=n[0].parseFloatWithUnits("kM",.001),o=kiwi_decodeURIComponent("hfdl",n[0]).toLowerCase();dbgUs&&console.log("URL freq="+d);var s=0,_=hfdl_menu_match(d,o);_.found_menu_match&&n.shift(),n.forEach(function(e,l){var t;if(dbgUs&&console.log("HFDL param2 <"+e+">"),w3_ext_param("help",e).match)extint_help_click();else if((t=w3_ext_param("display",e)).match){if(isNumber(t.num)){var n=w3_clamp(t.num,0,hfdl.dsp_s.length-1,0);console.log("display "+t.num+" "+n),hfdl_display_cb("id-hfdl.dsp",n)}}else(t=w3_ext_param("log_time",e)).match?isNumber(t.num)&&hfdl_log_mins_cb("id-hfdl.log_mins",t.num):w3_ext_param("test",e).match?s=1:console.log('HFDL: unknown URL param "'+e+'"')}),_.found_menu_match&&hfdl_pre_select_cb(_.match_menu,_.match_val,!1)}s&&hfdl_test_cb("",1),dbgUs&&console.log(hfdl.stations)}}function hfdl_render_menus(){var e,l=[];for(e=0;e<hfdl.bf.length;e++)l[e]=[];var t=function(t){var n=parseInt(t);for(e=0;e<hfdl.bf.length;e++)if(n<1e3*hfdl.bf[e]){l[e].push(t);break}},n=function(e,l,n,d){var o=kiwi_deep_copy(n);hfdl.menu_n++,hfdl["menu"+l]=-1,hfdl.menus[l]=o,hfdl.menu_s[l]=d;var s=[];w3_obj_enum(o,function(e,n,d){var o=d.name.split(", ")[1];d.frequencies.sort(function(e,l){return parseInt(e)-parseInt(l)});var _=[];d.frequencies.forEach(function(e){if(e<hfdl.bf.length){var n=[o,"w3-bold w3-text-blue"];_.push(n)}else _.push(e);0==l&&0!=e&&t(e+" "+o)}),0==l?s[o]=_:s.push(_)});var _=w3_select_hier(hfdl.sfmt,d,"select","hfdl.menu"+l,-1,s,"hfdl_pre_select_cb"),i=w3_create_appendElement(e,"div",_);w3_add(i,"id-"+d)},d=w3_el("id-hfdl-menus");d.innerHTML="",hfdl.menu_n=0,w3_obj_enum(hfdl.stations,function(e,l,t){"stations"==e&&n(d,0,t,"Stations")});var o=[];for(e=0;e<hfdl.bf.length;e++){l[e].sort(function(e,l){return parseInt(l)-parseInt(e)});var s={};s.name="x, "+hfdl.bf_s[e]+" MHz",s.frequencies=[e],l[e].forEach(function(e){s.frequencies.push(e)}),o[e.toString()]=s}n(d,1,o,"Bands")}function hfdl_format_cb(e,l,t){t||(hfdl.format_m=+l,w3_set_value(e,+l),hfdl_render_menus())}function hfdl_msg(e,l){var t=w3_el("id-hfdl-msg");w3_remove_then_add(t,hfdl.msg_last_color,e),hfdl.msg_last_color=e,t.innerHTML="<b>"+l+"</b>"}function hfdl_clear_menus(e){for(var l=0;l<hfdl.menu_n;l++)isArg(e)&&l==e||w3_select_value("hfdl.menu"+l,-1)}function hfdl_np_pre_select_cb(e,l,t){hfdl_pre_select_cb(e,l,t)}function hfdl_pre_select_cb(e,l,t){if(!t){l=+l,dbgUs&&console.log("hfdl_pre_select_cb path="+e+" val="+l);var n=parseInt(e.split("hfdl.menu")[1]);dbgUs&&console.log("hfdl_pre_select_cb path="+e+" val="+l+" menu_n="+n);var d="",o=0,s=!1;w3_select_enum(e,function(t){if(!s){dbgUs&&console.log("hfdl_pre_select_cb menu_n="+n+" opt.val="+t.value+" opt.disabled="+t.disabled+" opt.inner="+t.innerHTML+" opt.id="+t.id);var _=0==n&&t.disabled&&-1!=t.value,i=1==n&&t.id&&0==t.id.split("-")[2];if(dbgUs&&console.log("menu0_hdr="+_+" menu1_hdr="+i),_||i?(d=o?d+" "+t.innerHTML:t.innerHTML,o=1):o=0,t.value==l){s=!0,hfdl.cur_menu=n,hfdl.cur_header=d,hfdl.menu_sel=t.innerHTML+" ",dbgUs&&console.log("hfdl_pre_select_cb opt.val="+t.value+" menu_sel="+hfdl.menu_sel+" opt.id="+t.id);var a=t.id.split("id-")[1];if(isUndefined(a))return console.log("hfdl_pre_select_cb: option.id isUndefined"),console.log("hfdl_pre_select_cb opt.val="+t.value+" opt.disabled="+t.disabled+" opt.inner="+t.innerHTML),void console.log(t);var r=(a=a.split("-"))[0],f=a[1];dbgUs&&console.log("hfdl_pre_select_cb i="+r+" j="+f);var h=w3_obj_seq_el(hfdl.menus[n],r);dbgUs&&w3_console.log(h,"o1"),o2=w3_obj_seq_el(h.frequencies,f),dbgUs&&w3_console.log(o2,"o2");var c=null,u=0;if(o2=parseInt(o2),isNumber(o2))if(dbgUs&&console.log(o2),o2<hfdl.bf.length){var m=hfdl.bf_z[o2],b=hfdl.bf_c[o2];zoom_level==m&&zoom_step(ext_zoom.OUT),ext_tune(b,"iq",ext_zoom.ABS,m),dx.db==dx.DB_EiBi&&dx_is_single_type(dx.DX_HFDL)||(dx_set_type(dx.DX_HFDL),dx_database_cb("",dx.DB_EiBi)),u=1}else hfdl_tune(o2),c=(+o2).toFixedNZ(1)+" kHz",u=1;u&&hfdl_msg("w3-text-css-yellow",hfdl.menu_s[n]+", "+hfdl.cur_header+(c?": "+c:"")),w3_select_value(e,l)}}}),hfdl_clear_menus(n)}}function hfdl_tune(e){dbgUs&&console.log("hfdl_tune tx f="+e.toFixed(2)),hfdl.freq=e,ext_tune(e,"iq",ext_zoom.CUR),ext_set_passband(hfdl.pb.lo,hfdl.pb.hi),ext_send("SET display_freq="+e.toFixed(2))}function hfdl_clear_button_cb(e,l,t){t||(hfdl.console_status_msg_p.s=encodeURIComponent("\f"),kiwi_output_msg("id-hfdl-console-msgs","id-hfdl-console-msg",hfdl.console_status_msg_p),hfdl.log_txt="",hfdl_test_cb("",0))}function hfdl_display_cb(e,l,t){t||(l=+l,hfdl.dsp=l,w3_set_value(e,l))}function hfdl_test_cb(e,l,t){if(!t){l=+l,dbgUs&&console.log("hfdl_test_cb: val="+l),hfdl.testing=l,w3_el("id-hfdl-bar").style.width="0%",w3_show_hide("id-hfdl-bar-container",hfdl.testing);var n=-(+ext_get_freq_kHz()).toFixed(2);dbgUs&&console.log("hfdl_test_cb="+(l?n:0)),ext_send("SET test="+(l?n:0))}}function hfdl_log_mins_cb(e,l){hfdl.log_mins=w3_clamp(+l,0,1440,0),console.log("hfdl_log_mins_cb path="+e+" val="+l+" log_mins="+hfdl.log_mins),w3_set_value(e,hfdl.log_mins),kiwi_clearInterval(hfdl.log_interval),hfdl.log_mins&&(hfdl.log_interval=setInterval(function(){hfdl_log_cb()},6e4*hfdl.log_mins))}function hfdl_log_cb(){var e=kiwi_host()+"_"+(new Date).toISOString().replace(/:/g,"_").replace(/\.[0-9]+Z$/,"Z")+"_"+w3_el("id-freq-input").value+"_"+cur_mode,l=new Blob([hfdl.log_txt],{type:"text/plain"}),t=document.createElement("a");t.style="display: none",t.href=window.URL.createObjectURL(l),t.download="HFDL."+e+".log.txt",document.body.appendChild(t),console.log("hfdl_log: "+t.download),t.click(),window.URL.revokeObjectURL(t.href),document.body.removeChild(t)}function HFDL_environment_changed(e){if(e.freq||e.mode){var l=(+ext_get_freq_kHz()).toFixed(0),t=(+hfdl.freq).toFixed(0),n=ext_get_mode();if("iq"!=n)hfdl_clear_menus();else if(t!=l&&"iq"==n){var d=hfdl_menu_match(+l,l);d.found_menu_match&&hfdl_pre_select_cb(d.match_menu,d.match_val,!1)}}if(e.resize){var o=w3_el("id-hfdl-data"),s=(window.innerWidth-1024-time_display_width())/2;o.style.left=px(s)}}function HFDL_blur(){ext_set_mode(hfdl.saved_mode),ext_agc_delay(hfdl.save_agc_delay)}function HFDL_help(e){if(e){var l=w3_text("w3-medium w3-bold w3-text-aqua","HFDL decoder help")+w3_div("w3-margin-T-8 w3-scroll-y|height:90%",w3_div("w3-margin-R-8",'Periodic downloading of the HFDL message log to a file can be specified. Adjust your browser settings so these files are downloaded and saved automatically without causing a browser popup window for each download.<br><br>URL parameters: <br><i>(menu match)</i> &nbsp; display:[012] &nbsp; scan[:<i>secs</i>] &nbsp; log_time:<i>mins</i> &nbsp; test<br><br>The first URL parameter can be a frequency entry from the "Bands" menu (e.g. "8977"). <br>[012] refers to the order of selections in the corresponding menu.<br><br>Keywords are case-insensitive and can be abbreviated. So for example these are valid: <br><i>ext=hfdl,8977</i> &nbsp;&nbsp; <i>ext=hfdl,8977,d:1</i> &nbsp;&nbsp; <i>ext=hfdl,8977,l:10</i><br>'));confirmation_show_content(l,610,280),w3_el("id-confirmation-container").style.height="100%"}return!0}function HFDL_config_html(){ext_config_html(hfdl,"hfdl","HFDL","HFDL configuration")}


